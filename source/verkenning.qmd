---
title: "Verkenning otterveilige fuiken"
format:
  html:
    code-fold: true
    code-summary: "Show the code"
---

```{r}
#| include: false
library(tidyverse)
library(DBI)
library(inbodb)
library(sf)
library(leaflet)
```

## Waar wordt gevangen in de buurt waar ook otters voorkomen?

Gebieden in VIS waar met schietfuiken gevangen is:

```{r}
connectie_vis <- connect_inbo_dbase("W0001_10_Vis")

query <- "SELECT DISTINCT dv.VispuntID, dv.VispuntCode, dv.VispuntOmschrijving,
  dv.LongWGS84, dv.LatWGS84, dv.VHAVispuntGemeente, dv.VHAVispuntNaam,
  dv.VHAVispuntBekkenNaam, dw.WaarnemingMethodecode, dv.VispuntX, dv.VispuntY,
  dv.WaterlichaamNaam
FROM DimWaarneming dw
INNER JOIN DimVispunt dv ON dw.WaarnemingVispuntID = dv.VispuntID
WHERE dw.WaarnemingMethodecode like 'SF%'"

location_sf <- dbGetQuery(connectie_vis, query, stringsAsFactors = FALSE)

location_sf_geom <- location_sf %>%
  st_as_sf(coords = c("VispuntX", "VispuntY"), crs = 31370) %>%
  st_transform(crs = 4326)

pal <- colorFactor(c("blue", "brown", "yellow"), domain = c("SF", "SFB", "SFO"))

leaflet(data = location_sf_geom) %>%
  addTiles() %>%
  addCircleMarkers(
    popup = ~VHAVispuntNaam,
    label = ~VHAVispuntNaam,
    color = ~pal(WaarnemingMethodecode)
  )
```

## Op zoek naar relevante gegevens om een idee te krijgen van de variatie

Schietfuiken met beverbescherming en evt. gewone schietfuiken op dezelfde locatie:

Samenvatting:

```{r}
location_sf %>%
  filter(WaarnemingMethodecode == "SFB") %>%
  left_join(
    location_sf %>%
      select(VispuntID, WaarnemingMethodecode) %>%
      filter(WaarnemingMethodecode != "SFB"),
    by = "VispuntID"
  ) %>%
  count(WaarnemingMethodecode.x, WaarnemingMethodecode.y)
```

Details:

```{r}
location_sf %>%
  filter(WaarnemingMethodecode == "SFB") %>%
  left_join(
    location_sf %>%
      select(VispuntID, WaarnemingMethodecode) %>%
      filter(WaarnemingMethodecode != "SFB"),
    by = "VispuntID"
  )
```

Wanneer is er op hetzelfde moment op die plaatsen gevangen?

```{r}
query <- "SELECT DISTINCT dv.VispuntID, dv.VispuntCode, dv.VHAVispuntNaam,
  dv.LongWGS84, dv.LatWGS84, dv.VHAVispuntGemeente, dv.VHAVispuntBekkenNaam,
  dw.WaarnemingMethodecode, dw.WaarnemingDatumWID, dv.VispuntX, dv.VispuntY,
  dv.WaterlichaamNaam
FROM DimWaarneming dw
INNER JOIN DimVispunt dv ON dw.WaarnemingVispuntID = dv.VispuntID
WHERE dw.WaarnemingMethodecode like 'SF%'"

waarneming_sf <- dbGetQuery(connectie_vis, query, stringsAsFactors = FALSE)

waarneming_sf %>%
  select(-VispuntX, -VispuntY) %>%
  filter(WaarnemingMethodecode == "SFB") %>%
  inner_join(
    waarneming_sf %>%
      select(VispuntID, WaarnemingMethodecode, WaarnemingDatumWID) %>%
      filter(WaarnemingMethodecode != "SFB", WaarnemingDatumWID > 20230101),
    by = "VispuntID",
    relationship = "many-to-many"
  ) %>%
  filter(WaarnemingDatumWID.x == WaarnemingDatumWID.y)
```

Wat als het niet op hetzelfde moment is?

```{r}
waarneming_sf %>%
  filter(
    VispuntID %in%
      (waarneming_sf %>% filter(WaarnemingMethodecode == "SFB"))$VispuntID,
    WaarnemingDatumWID > 20220101
  ) %>%
  ggplot(
    aes(
      x = WaarnemingDatumWID, y = VispuntCode, colour = WaarnemingMethodecode
    )
  ) + geom_point()
```

```{r}
waarneming_sf %>%
  filter(
    VispuntID %in%
      (waarneming_sf %>% filter(WaarnemingMethodecode == "SFB"))$VispuntID,
    WaarnemingDatumWID > 20223101,
    grepl("^ZG", VispuntCode)
  ) %>%
  select(VispuntCode, WaarnemingMethodecode, WaarnemingDatumWID)
```

Tussen die vangsten zitten maanden tussen, dus lijkt niet zinvol om ze te vergelijken.



Eens enkele gebieden ruimtelijk bekijken, bv. het Vinne en het Schulensmeer?
(Hoveren over de punten geeft de datum.)

Vinne

```{r}
waarneming_sf %>%
  filter(
    WaterlichaamNaam == "Vinne",
    WaarnemingDatumWID > 20220101
  ) %>%
  st_as_sf(coords = c("VispuntX", "VispuntY"), crs = 31370) %>%
  st_transform(crs = 4326) %>%
  leaflet() %>%
  addTiles() %>%
  addCircleMarkers(
    popup = ~WaarnemingDatumWID,
    label = ~WaarnemingDatumWID,
    color = ~pal(WaarnemingMethodecode)
  )
```

Schulensmeer

```{r}
waarneming_sf %>%
  filter(
    WaterlichaamNaam == "Schulens Meer",
    WaarnemingDatumWID > 20220101
  ) %>%
  st_as_sf(coords = c("VispuntX", "VispuntY"), crs = 31370) %>%
  st_transform(crs = 4326) %>%
  leaflet() %>%
  addTiles() %>%
  addCircleMarkers(
    popup = ~WaarnemingDatumWID,
    label = ~WaarnemingDatumWID,
    color = ~pal(WaarnemingMethodecode)
  )
```

## Waar verwachten we impact op de EQR?

Te verwachten impact op resultaat van index:

- bij fuikvangsten
- waar aantal lengteklassen van belang is
- soortenrijkdom als grotere soorten?

Dus effecten of mogelijke effecten bij:

- Brasem en Barbeel
    - MnsTot (alle soorten)
    - ManTol ?
    - ManTyp ?
    - ManSoort ?
    - ManBio
    - MpgExo ?
    - TrofComp ?
    - MpsRekr
- meren
    - BenWei
    - MpiOmn
    - MniPis ?
    - ManTol
- kanalen
    - ManRec
    - BenWei
- estuarien IJzer
    - MnsEst ?
    - MnsDia ?
    - RmniDia
    - MnsMjs ?
    - MnsTyp ?
- estuarien Schelde zoetwater
    - MnsTot ?
    - MniInd
    - MpiDia
    - MpiSpa
    - MpiPis
    - MpiBen
- estuarien Schelde oligohalien
    - MnsPis
    - MnsInt
    - MnsDia
    - MniInd
    - MnsMms ?
    - MnsErs ?
    - MnsTot ?
- estuarien Schelde mesohalien
    - MnsTot ?
    - MnsDia ?
    - MnsSpa ?
    - MnsHab ?
    - MpiInd
    - MnsMms ?
- estuarien Schelde brak
    - MnsTot
    - MpiSme ?
    - MpiMjm
    - MpiOmn
    - MpiPis
- estuarien zijrivieren zoet
    - ManSha ?
    - MpiInv
    - MpiSpa
    - MnsPis ?
    - MnsTot

